# EKS CNI 計算器使用說明

## 功能簡介

EKS CNI 計算器是一個專門用於計算 AWS EKS (Elastic Kubernetes Service) 集群中 CNI (Container Network Interface) 容量和 IP 需求的工具。

## 主要功能

### 1. Pod 容量計算

- 根據 EC2 實例類型自動計算每個節點可運行的最大 Pod 數量
- 支援標準模式和 Prefix 模式兩種計算方式
- 計算整個集群的總 Pod 容量

### 2. IP 需求分析

- 計算子網路的可用 IP 數量
- 分析集群所需的 IP 總數
- 顯示剩餘 IP 數量和使用率
- 提供 IP 資源警告和建議

### 3. 實例類型支援

支援多種 AWS EC2 實例類型：

- **T3 系列**: 適合開發和測試環境
- **M5 系列**: 通用型工作負載
- **C5 系列**: 計算密集型應用
- **R5 系列**: 記憶體密集型應用

## 使用方式

### 基本步驟

1. **選擇 EC2 實例類型**

   - 從下拉選單中選擇您的節點實例類型
   - 系統會自動顯示該實例的 ENI 和 IP 限制

2. **輸入子網路 CIDR**

   - 輸入您的子網路 CIDR 記號（例如：10.0.1.0/24）
   - 系統會計算可用的 IP 數量

3. **設定節點數量**

   - 輸入集群中的節點數量
   - 系統會計算總容量和 IP 需求

4. **選擇 CNI 模式**
   - **標準模式**: 每個 IP 對應一個 Pod
   - **Prefix 模式**: 啟用後可大幅增加 Pod 密度（每個 IP 可分配 16 個 Pod）

### 快速範例

工具提供了四個預設範例：

- **小型集群**: t3.medium × 3 節點
- **中型集群**: t3.large × 5 節點
- **大型集群**: m5.xlarge × 10 節點
- **超大型集群**: c5.2xlarge × 20 節點

## 計算公式

### 標準模式

```
最大 Pod 數 = (ENI 數量 × 每 ENI IP 數) - 1
```

減 1 是因為主 ENI 的主 IP 用於節點本身

### Prefix 模式

```
最大 Pod 數 = (ENI 數量 - 1) × 16 × 每 ENI IP 數 + (每 ENI IP 數 - 1)
```

Prefix 模式下每個 IP 可分配 16 個 Pod

## 結果說明

### CNI 容量計算

- **每節點最大 ENI 數**: 該實例類型支援的網路介面數量
- **每 ENI IP 數**: 每個網路介面可分配的 IP 數量
- **每節點最大 Pod 數**: 單個節點可運行的最大 Pod 數量
- **集群總 Pod 容量**: 整個集群可運行的總 Pod 數量

### 子網路資訊

- **可用 IP 總數**: 子網路中可用的 IP 數量（扣除 AWS 保留的 5 個 IP）
- **所需 IP 數**: 集群運行所需的 IP 總數
- **剩餘 IP 數**: 可用於擴展的剩餘 IP
- **IP 使用率**: 當前 IP 使用百分比

### 警告提示

系統會根據計算結果提供以下警告：

- IP 不足警告（使用率 > 100%）
- IP 使用率過高警告（> 90%）
- IP 使用率警告（> 80%）
- Pod 密度建議

## 最佳實踐建議

### 1. IP 規劃

- 建議預留 10-20% 的 IP 空間用於擴展
- 避免 IP 使用率超過 80%
- 考慮未來的擴展需求

### 2. Prefix 模式

- 適合需要高 Pod 密度的場景
- 可以大幅減少 IP 消耗
- 需要 EKS 1.19+ 版本支援

### 3. 實例選擇

- 根據工作負載選擇合適的實例類型
- 較大的實例類型支援更多 ENI 和 IP
- 平衡成本和容量需求

### 4. 子網路設計

- 使用適當大小的子網路（建議 /24 或更大）
- 避免子網路過小導致 IP 不足
- 考慮多可用區部署的 IP 需求

## 常見問題

### Q: 為什麼實際可用 Pod 數比計算結果少？

A: EKS 會為系統 Pod（如 kube-proxy、aws-node）預留一些容量。

### Q: 什麼時候應該使用 Prefix 模式？

A: 當您需要在單個節點上運行大量 Pod，或者希望節省 IP 資源時。

### Q: 如何選擇合適的子網路大小？

A: 根據計算結果，確保有足夠的 IP 並預留 10-20% 的擴展空間。

### Q: AWS 為什麼保留 5 個 IP？

A: AWS 在每個子網路中保留：

- 網路地址（第 1 個 IP）
- VPC 路由器（第 2 個 IP）
- DNS 伺服器（第 3 個 IP）
- 未來使用（第 4 個 IP）
- 廣播地址（最後 1 個 IP）

## 參考資源

- [AWS VPC CNI 官方文檔](https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html)
- [EKS 最佳實踐指南](https://aws.github.io/aws-eks-best-practices/)
- [EC2 實例網路規格](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html)
